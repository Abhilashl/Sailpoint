/*
    Rule:  aci_AccountType
    
    Author:  Steve Nuffer
	
    Date:  August 10, 2016
    Version:  1.6

*/
import org.apache.log4j.Logger;
import sailpoint.object.*;
import sailpoint.tools.Util; 

// Declare a logger class
Logger logger = Logger.getLogger("com.aci.rule.aci_AccountType");

//Setup Variables Custom Map
Custom custom = context.getObjectByName(Custom.class,"accountTypeMap");
String tmpAcctType = "Unknown";
Application app = link.getApplication();
String appConnectorType = app.getConnector();
Identity identityObj = link.getIdentity();
String identityEmail = identityObj.getEmail();
boolean authIdentity = identityObj.isCorrelated();
String identitytName  = identityObj.getDisplayName();

// Based upon connector Type
switch (appConnectorType) {
     //**************************************************************************
     //*****  Active Directory
     case "sailpoint.connector.ADLDAPConnector":
            // Get the Active Directory's Attributes
            String acctSamName = link.getAttribute("sAMAccountName");
            String acctDistinguishedName = link.getAttribute("distinguishedName");
            String acctMail = link.getAttribute("mail");
              
            if ( acctSamName != null && acctSamName != void && !(acctSamName.equals("")) ) {

                //********************
                // Check the XML file for special cases
                try {
                    tmpAcctType	= custom.get("Active Directory").get("Users").get(acctSamName).get("Account Type");
                } catch(Exception e) {
                    ;  // Do nothing
                }
                
                //********************
                // Check if Account Type = Service
                if ( acctDistinguishedName.toLowerCase().contains("ou=service accounts") ) {
                    tmpAcctType = "Service";
                }

                //********************
                // Check if Account Type = Personal-Primary OR Personal-Other
                if ( authIdentity ) {
                    if ( null != acctMail ) {
                        tmpAcctType = "Personal-Primary";
                    } else {
                        tmpAcctType = "Personal-Other";
                    }
                }
            }         
            break;
     //**************************************************************************
     //*****  Salesforce
     case "sailpoint.connector.ForceConnector":
            // Get the applications native account
            String acctNativeIdentity = link.getNativeIdentity();
            String acctMail = link.getAttribute("Email");

            //********************
            // Check if Account Type = Personal-Primary OR Personal-Other
            if ( authIdentity ) {
                if ( null != acctMail ) {
                    if ( Util.isNotNullOrEmpty(identityEmail) && acctNativeIdentity.equalsIgnoreCase( identityEmail ) ) {
                        tmpAcctType = "Personal-Primary";
                    }
                    else {
                        tmpAcctType = "Personal-Other";
                    }
                } else {
                    tmpAcctType = "Personal-Other";   
                }
            }
            break;            
} // switch end

logger.debug("appConnectorType=" + appConnectorType + "(" + identitytName + ") acctSamName=" + acctSamName + " identityEmail=" + identityEmail + " AcctType=" + tmpAcctType );
return tmpAcctType;